@using System.Reflection
@inject NavigationManager Nav
@inject AuthState AuthState

@if (!_isRedirecting)
{
    <RouteView RouteData="@RouteData" DefaultLayout="@DefaultLayout" />
}

@code {
    [Parameter, EditorRequired] public RouteData RouteData { get; set; } = default!;
    [Parameter, EditorRequired] public Type DefaultLayout { get; set; } = default!;

    private bool _isRedirecting;

    protected override void OnParametersSet()
    {
        var requiresAuth = RouteData.PageType.GetCustomAttribute<RequireAuthAttribute>(inherit: true) != null;

        if (requiresAuth && !AuthState.IsAuthenticated)
        {
            _isRedirecting = true;

            // Preserve current route for post-login redirect
            var relative = Nav.ToBaseRelativePath(Nav.Uri);
            var path = string.IsNullOrWhiteSpace(relative) ? "/" : "/" + relative;
            var returnUrl = Uri.EscapeDataString(path);
            Nav.NavigateTo($"/login?returnUrl={returnUrl}");
            return;
        }

        _isRedirecting = false;
    }
}


