@using WebFrontend.Components.UI.Shared
@using WebFrontend.Components.UI.Select
@using WebFrontend.Services

@* Fully custom dropdown-style select (no native <select>, no DropdownMenu dependency) *@
<div class="@ClassBuilder.Merge("relative inline-block w-full text-left", OuterClass)">
    <button type="button"
            class='@ClassBuilder.Merge("flex w-full items-center justify-between rounded-full border border-input bg-background/80 px-3 py-2.5 text-sm shadow-xs outline-none transition-colors focus-visible:border-ring focus-visible:ring-[3px] focus-visible:ring-ring/40 disabled:cursor-not-allowed disabled:opacity-50", Class)'
            disabled="@Disabled"
            @onclick="ToggleAsync"
            @ref="_triggerRef">
        <span class="truncate text-left">
            @DisplayText
        </span>
        <span class="ml-2 flex items-center text-muted-foreground">
            <svg class="h-4 w-4 transition-transform duration-150 @( _open ? "rotate-180" : "" )"
                 viewBox="0 0 20 20" fill="none" aria-hidden="true">
                <path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </span>
    </button>

    @if (_open)
    {
        @* overlay to close on outside click *@
        <div class="fixed inset-0 z-40" @onclick="CloseAsync"></div>

        <div class="absolute z-50 w-full overflow-hidden rounded-xl border border-border bg-card shadow-lg @GetPositionClasses() @AnimationClass"
             @onclick:stopPropagation="true">
            @if (!string.IsNullOrEmpty(Label))
            {
                <div class="px-3 pt-3 pb-1 text-xs font-medium text-muted-foreground">
                    @Label
                </div>
            }

            <ul class="py-1.5">
                @foreach (var option in Options)
                {
                    var isSelected = IsOptionSelected(option);
                    <li>
                        <button type="button"
                                disabled="@option.Disabled"
                                class="@GetItemClasses(option, isSelected)"
                                @onclick="() => SelectAsync(option.Value)">
                            @if (isSelected)
                            {
                                <span class="mr-2 flex shrink-0 items-center">
                                    <svg class="h-4 w-4 text-primary-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                    </svg>
                                </span>
                            }
                            <span class="flex-1 text-left truncate">
                                @option.Label
                            </span>
                        </button>
                    </li>
                }
            </ul>
        </div>
    }
</div>

@code {
    [Parameter] public IReadOnlyList<SelectOption> Options { get; set; } = Array.Empty<SelectOption>();
    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string?> ValueChanged { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public string? Placeholder { get; set; }
    [Parameter] public string? Label { get; set; }
    [Parameter] public DropdownDirection Direction { get; set; } = DropdownDirection.Auto;
    [Parameter(CaptureUnmatchedValues = true)] public Dictionary<string, object>? AdditionalAttributes { get; set; }

    [Parameter] public string? OuterClass { get; set; }
    [Parameter] public string? Class { get; set; }

    [Inject] private ScrollLockService ScrollLockService { get; set; } = default!;
    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;

    private bool _open;
    private bool _isClosing;
    private bool _openUpwards;
    private ElementReference _triggerRef;
    private IJSObjectReference? _jsModule;

    private string AnimationClass =>
        _isClosing
            ? _openUpwards
                ? "animate-[select-out-up_140ms_cubic-bezier(0.2,0.8,0.2,1)_forwards]"
                : "animate-[select-out-down_140ms_cubic-bezier(0.2,0.8,0.2,1)_forwards]"
            : _openUpwards
                ? "animate-[select-in-up_160ms_cubic-bezier(0.2,0.8,0.2,1)_forwards]"
                : "animate-[select-in-down_160ms_cubic-bezier(0.2,0.8,0.2,1)_forwards]";

    private string DisplayText
    {
        get
        {
            // Prefer matching option label when we have a value
            if (!string.IsNullOrEmpty(Value) && Options is not null)
            {
                foreach (var option in Options)
                {
                    if (string.Equals(option.Value, Value, StringComparison.Ordinal))
                    {
                        return option.Label;
                    }
                }

                // Fallback: show raw value if no option matches
                return Value!;
            }

            // No value yet â€“ fall back to placeholder or generic text
            return Placeholder ?? "Select an option";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _jsModule is null)
        {
            try
            {
                _jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/select.js");
            }
            catch (JSException)
            {
                // JS module not available; fall back to downward-only.
            }
        }
    }

    private SelectOption? FindOption(string? value)
    {
        if (Options is null || value is null) return null;

        foreach (var option in Options)
        {
            if (option.Value == value)
                return option;
        }

        return null;
    }

    private bool IsOptionSelected(SelectOption option)
    {
        if (Value is null || option.Value is null)
            return false;

        return string.Equals(option.Value, Value, StringComparison.Ordinal);
    }

    private string GetItemClasses(SelectOption option, bool isSelected)
    {
        var baseClasses = "flex w-full items-center px-3 py-2 text-sm rounded-md transition-colors";

        if (option.Disabled)
        {
            return $"{baseClasses} text-muted-foreground/60 cursor-not-allowed";
        }

        if (isSelected)
        {
            return $"{baseClasses} bg-primary text-primary-foreground";
        }

        return $"{baseClasses} cursor-pointer text-foreground hover:bg-muted/70";
    }

    private async Task ToggleAsync()
    {
        if (Disabled) return;

        if (_open)
        {
            await StartCloseAnimationAsync();
            return;
        }

        _isClosing = false;
        _open = true;
        await ScrollLockService.LockAsync();
        await DetermineDirectionAsync();
        StateHasChanged();
    }

    private Task CloseAsync()
    {
        if (!_open) return Task.CompletedTask;
        return StartCloseAnimationAsync();
    }

    private async Task SelectAsync(string value)
    {
        if (Disabled) return;

        if (ValueChanged.HasDelegate)
        {
            await ValueChanged.InvokeAsync(value);
        }

        await StartCloseAnimationAsync();
    }

    private async Task StartCloseAnimationAsync()
    {
        _isClosing = true;
        StateHasChanged();

        await Task.Delay(140);

        _open = false;
        _isClosing = false;
        await ScrollLockService.UnlockAsync();
        StateHasChanged();
    }

    private async Task DetermineDirectionAsync()
    {
        // Explicit overrides from caller
        if (Direction == DropdownDirection.Up)
        {
            _openUpwards = true;
            return;
        }

        if (Direction == DropdownDirection.Down)
        {
            _openUpwards = false;
            return;
        }

        // Auto mode: prefer JS-based viewport measurement when available
        if (_jsModule != null)
        {
            try
            {
                var result = await _jsModule.InvokeAsync<string>("chooseSelectDirection", _triggerRef);
                _openUpwards = string.Equals(result, "up", StringComparison.OrdinalIgnoreCase);
                return;
            }
            catch (JSException)
            {
                // Ignore and fall through to default
            }
        }

        // Fallback: open downward
        _openUpwards = false;
    }

    private string GetPositionClasses()
    {
        // When opening upwards, align to bottom of trigger; otherwise below it.
        return _openUpwards
            ? "bottom-full mb-1 left-0 origin-bottom"
            : "mt-1 left-0 origin-top";
    }
}

