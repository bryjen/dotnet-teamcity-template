
@Render

@* ReSharper disable once UnusedParameter.Local *@
@code {
    private RenderFragment Render => __builder =>
    {
        <div class="min-h-14 bg-card border-b border-border">
            <div class="w-full px-4 flex items-center justify-between">
                <a class="text-lg font-semibold text-foreground" href="">WebFrontend</a>

                @*
                <div class="flex items-center gap-4">
                    <AuthorizeView>
                        <Authorized>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-muted-foreground">@context.User.Identity?.Name</span>
                                <button
                                    @onclick="HandleLogout"
                                    class="text-sm text-muted-foreground hover:text-foreground transition-colors">
                                    Logout
                                </button>
                            </div>
                        </Authorized>
                        <NotAuthorized>
                            <NavLink href="/auth" class="text-sm text-muted-foreground hover:text-foreground transition-colors">
                                Login
                            </NavLink>
                        </NotAuthorized>
                    </AuthorizeView>
                    <button title="Navigation menu" class="md:hidden p-2 rounded-md bg-muted hover:bg-muted/80 text-foreground transition-colors" @onclick="ToggleNavMenu">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
                *@
            </div>
        </div>

        <div class="md:h-[calc(100vh-3.5rem)] md:overflow-y-auto flex flex-col" @onclick="ToggleNavMenu">
            <AuthorizeView>
                <Authorized>
                    @RenderAuthorizedPanel
                </Authorized>
            </AuthorizeView>

            @* Footer with auth buttons *@
            <div class="border-t border-border p-4 mt-auto">
                <AuthorizeView>
                    <Authorized>
                        <div class="flex flex-col gap-2">
                            <div class="text-sm font-medium text-foreground truncate">
                                @GetUsername(context)
                            </div>
                            <NavLink href="/settings/personal-information" class="w-full px-3 py-2 text-sm text-muted-foreground hover:text-foreground hover:bg-accent rounded-md transition-colors text-left flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                Settings
                            </NavLink>
                            <button
                                @onclick="HandleLogout"
                                class="w-full px-3 py-2 text-sm text-muted-foreground hover:text-foreground hover:bg-accent rounded-md transition-colors text-left">
                                Logout
                            </button>
                        </div>
                    </Authorized>
                    <NotAuthorized>
                        <div class="flex flex-col gap-2">
                            <NavLink href="/auth" class="w-full px-3 py-2 text-sm text-center bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors">
                                Login
                            </NavLink>
                            <NavLink href="/auth?mode=register" class="w-full px-3 py-2 text-sm text-center border border-input bg-background text-foreground rounded-md hover:bg-accent transition-colors">
                                Register
                            </NavLink>
                        </div>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
        </div>
    };

    private RenderFragment RenderAuthorizedPanel => __builder =>
    {
        <div class="flex flex-col flex-1 overflow-hidden">
            @* Dashboard link *@
            <div class="p-3 border-b border-border">
                <NavLink 
                    href="/dashboard"
                    class="w-full px-4 py-2.5 bg-muted hover:bg-muted/80 text-foreground rounded-md font-medium transition-colors flex items-center justify-center gap-2 no-underline">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    Dashboard
                </NavLink>
            </div>
            
            @* Symptom Map link *@
            <div class="p-3 border-b border-border">
                <NavLink 
                    href="/symptom-map"
                    class="w-full px-4 py-2.5 bg-muted hover:bg-muted/80 text-foreground rounded-md font-medium transition-colors flex items-center justify-center gap-2 no-underline">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                    </svg>
                    Symptom Map
                </NavLink>
            </div>
            
            @* button for new chat *@
            <div class="p-3 border-b border-border">
                <button
                    @onclick="StartNewChat"
                    class="w-full px-4 py-2.5 bg-muted hover:bg-muted/80 text-foreground rounded-md font-medium transition-colors flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    New Chat
                </button>
            </div>

            @* recent chats section *@
            <div class="flex flex-col flex-1 overflow-hidden">
                <div class="px-3 pt-4 pb-2">
                    <h2 class="text-xs font-semibold text-muted-foreground uppercase tracking-wider">RECENT CHATS</h2>
                </div>

                @* search bar *@
                <div class="px-3 pb-3">
                    <div class="relative">
                        <input
                            type="text"
                            @bind="SearchQuery"
                            @bind:event="oninput"
                            placeholder="Search chats..."
                            class="w-full px-3 py-2 pr-10 text-sm bg-muted border border-input rounded-md text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-1" />
                        <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>

                @RenderConversationsPanel
            </div>
        </div>
    };

    /// <remarks>
    /// Requires authenticated user. See caller above.
    /// </remarks>
    private RenderFragment RenderConversationsPanel => __builder =>
    {
        <div class="flex-1 overflow-y-auto px-3 pb-3">
            @if (IsLoadingConversations)
            {
                <div class="text-center py-8 text-sm text-muted-foreground">Loading...</div>
            }
            else if (FilteredConversations.Count == 0)
            {
                <div class="text-center py-8 text-sm text-muted-foreground">
                    @(string.IsNullOrWhiteSpace(SearchQuery) ? "No conversations yet" : "No conversations found")
                </div>
            }
            else
            {
                @foreach (var conversation in FilteredConversations)
                {
                    <div class="relative group/item mb-1 rounded-md hover:bg-accent transition-colors">
                        <NavLink
                            href="@($"/chat?conversation={conversation.Id}")"
                            class="flex items-start gap-3 p-2">
                            <svg class="w-5 h-5 text-muted-foreground mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                            </svg>
                            <div class="flex-1 min-w-0 max-w-[80%]">
                                <div class="text-sm font-medium text-foreground truncate">
                                    @conversation.Title
                                </div>
                                @if (!string.IsNullOrWhiteSpace(conversation.LastMessagePreview))
                                {
                                    <div class="text-xs text-muted-foreground truncate mt-0.5">
                                        @conversation.LastMessagePreview
                                    </div>
                                }
                            </div>
                        </NavLink>

                        <!-- Dropdown Button -->
                        <button
                            @onclick="() => ToggleDropdownAsync(conversation.Id)"
                            @onclick:stopPropagation="true"
                            @onclick:preventDefault="true"
                            data-dropdown-trigger="@conversation.Id"
                            class="absolute right-2 top-1/2 -translate-y-1/2 p-1.5 rounded-md opacity-0 group-hover/item:opacity-100 hover:opacity-100 hover:bg-muted transition-opacity z-10"
                            title="More options">
                            <svg class="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                            </svg>
                        </button>

                        <!-- Dropdown Menu -->
                        @if (OpenDropdownId == conversation.Id)
                        {
                            <div class="absolute right-0 top-full mt-1 w-48 bg-card border border-border rounded-md shadow-lg z-50" data-dropdown-id="@conversation.Id" @onclick:stopPropagation="true">
                                <div class="py-1">
                                    <!-- Star (disabled) -->
                                    <button
                                        disabled
                                        class="w-full px-4 py-2 text-sm text-muted-foreground flex items-center gap-2 cursor-not-allowed opacity-50">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                        </svg>
                                        Star
                                    </button>

                                    <!-- Rename (disabled) -->
                                    <button
                                        disabled
                                        class="w-full px-4 py-2 text-sm text-muted-foreground flex items-center gap-2 cursor-not-allowed opacity-50">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                        Rename
                                    </button>

                                    <!-- Add to project (disabled) -->
                                    <button
                                        disabled
                                        class="w-full px-4 py-2 text-sm text-muted-foreground flex items-center gap-2 cursor-not-allowed opacity-50">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                        </svg>
                                        Add to project
                                    </button>

                                    <!-- Divider -->
                                    <div class="border-t border-border my-1"></div>

                                    <!-- Delete (enabled) -->
                                    <button
                                        @onclick="() => HandleDeleteConversation(conversation.Id)"
                                        @onclick:stopPropagation="true"
                                        disabled="@IsDeleting"
                                        class="w-full px-4 py-2 text-sm text-red-500 flex items-center gap-2 hover:bg-accent transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                        Delete
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>
    };
}
