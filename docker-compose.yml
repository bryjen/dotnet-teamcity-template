services:
  webapi:
    build:
      context: .
      dockerfile: src/WebApi/Dockerfile
    container_name: asptemplate-webapi
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
      # Database (from .env)
      ConnectionStrings__DefaultConnection: "${WEBAPI_CONNECTION_STRING}"
      # JWT
      Jwt__Secret: "${JWT_SECRET}"
      Jwt__Issuer: "TodoAppApi"
      Jwt__Audience: "TodoAppClient"
      Jwt__ExpirationInDays: "7"
      # CORS (frontend runs on host at :5026)
      Cors__AllowedOrigins: "http://localhost:5026"
      # OpenTelemetry (traces)
      OTEL_SERVICE_NAME: "WebApi"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"
    ports:
      - "8080:8080"
    depends_on:
      - otel-collector
    volumes:
      - tailscale-state:/var/lib/tailscale

  tailscale:
    image: tailscale/tailscale:latest
    container_name: asptemplate-tailscale
    network_mode: "service:webapi"
    depends_on:
      - webapi
    environment:
      # Tailscale authentication key (get from https://login.tailscale.com/admin/settings/keys)
      # This should be a reusable auth key for the container
      TS_AUTHKEY: "${TAILSCALE_AUTHKEY:-}"
      # State directory (persisted via volume)
      TS_STATE_DIR: "/var/lib/tailscale"
      # Optional: Set a hostname for this device in Tailscale
      TS_HOSTNAME: "${TAILSCALE_HOSTNAME:-asptemplate-webapi}"
      # Optional: Set user (if using auth key, this may not be needed)
      TS_USER: "${TAILSCALE_USER:-}"
    volumes:
      - tailscale-state:/var/lib/tailscale
    restart: unless-stopped

  webfrontend:
    build:
      context: .
      dockerfile: src/WebFrontend/Dockerfile
      args:
        API_BASE_URL: "${API_BASE_URL:-http://localhost:8080/}"
    container_name: asptemplate-webfrontend
    environment:
      # Runtime configuration - replaces appsettings.json values at container startup
      # This allows changing config without rebuilding the image
      API_BASE_URL: "${API_BASE_URL:-http://localhost:8080}"
    depends_on:
      - webapi
    ports:
      - "5026:8080"

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.96.0
    container_name: asptemplate-otel-collector
    command: ["--config=/etc/otelcol/config.yml"]
    volumes:
      - ./observability/otel-collector-config.yml:/etc/otelcol/config.yml:ro
    # No host ports: receiver is only reachable from within the compose network

  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:8.0
    container_name: asptemplate-aspire-dashboard
    environment:
      DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS: "true"
      ASPNETCORE_URLS: "http://0.0.0.0:18888"
      DOTNET_DASHBOARD_OTLP_ENDPOINT_URL: "http://0.0.0.0:18889"
    ports:
      - "127.0.0.1:18888:18888"
    depends_on:
      - otel-collector

volumes:
  tailscale-state:
    driver: local

